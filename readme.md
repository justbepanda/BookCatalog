# Book Catalog Service (Yii 1.1 + Docker)

Современная инфраструктура для классического приложения на Yii 1.1. Сервис позволяет управлять каталогом книг и авторов, а также автоматически уведомляет подписчиков о выходе новых книг через SMS.

## Стек технологий
* **Framework:** Yii 1.1.28
* **PHP:** 8.2 (FPM)
* **Database:** MySQL 8.0
* **Server:** Nginx
* **Testing:** PHPUnit 9.6
* **Containerization:** Docker / Docker Compose

## Установка и запуск

### Системные требования
* Docker & Docker Compose
* Make
* Git


### Быстрый старт

Клонируйте репозиторий:

```Bash 
git clone https://github.com/justbepanda/BookCatalog.git
```

Все основные операции автоматизированы через Makefile:

```Bash 
make init
```

_Эта команда соберет контейнеры, установит зависимости Composer, создаст структуру приложения, накатит миграции и добавит сиды._

### Доступ к сервису

*   **Web UI:** [http://localhost:8080](https://www.google.com/search?q=http://localhost:8080)

*   **Database:** localhost:3307 (извне) или сервис db (внутри сети Docker)


Тестирование
---------------

Проект настроен для работы с современным PHPUnit 9, несмотря на использование ядра Yii 1.1. Для корректной работы реализованы заглушки для устаревших классов PHPUnit.

### Подготовка тестовой БД

Перед первым запуском тестов необходимо создать тестовую базу данных и синхронизировать схему:

```Bash
make test-prep
```
### Запуск тестов

*   **Все тесты:** make test

*   **Unit-тесты:** make test-unit

*   **Конкретный файл:** make test-file file=BookTest.php


Система уведомлений
----------------------

Сервис реализует асинхронную отправку SMS уведомлений:

1.  При создании книги срабатывает afterSave в модели Book.

2.  Записи о необходимости отправки попадают в таблицу sms\_queue.

3.  Консольная команда обрабатывает очередь и отправляет запросы к SMS Pilot.


**Ручной запуск воркера:**

```Bash
make shell  ./protected/yiic smsqueue process
```

Команды Makefile
-------------------

`make up / down` Запуск и остановка контейнеров

`make shell` Вход в консоль PHP-контейнера

`make migrate` Выполнение миграций БД

`make test` Запуск всех тестов

`make help` Полный список доступных команд